# MyBox Loan File Management System
# Firebase Data Connect Schema

type User @table {
  id: UUID! @default(expr: "uuidV4()")
  email: String! @col(name: "email")
  firstName: String @col(name: "first_name")
  lastName: String @col(name: "last_name")
  role: String! @default(value: "borrower") # 'admin' or 'borrower'
  isActive: Boolean! @default(value: true)
  phoneNumber: String @col(name: "phone_number")
  # Authentication fields
  hasPassword: Boolean! @default(value: false) @col(name: "has_password")
  googleAuthUid: String @col(name: "google_auth_uid") # Google Sign-In UID
  isTemporary: Boolean! @default(value: true) @col(name: "is_temporary") # True for magic link users without password
  createdAt: Timestamp! @default(expr: "request.time")
  updatedAt: Timestamp! @default(expr: "request.time")
  lastLoginAt: Timestamp @col(name: "last_login_at")
}

# Index on email for fast lookups
extend type User @index(fields: ["email"], name: "idx_user_email")
extend type User @index(fields: ["role"], name: "idx_user_role")
extend type User @index(fields: ["googleAuthUid"], name: "idx_user_google_uid")

type Loan @table {
  id: UUID! @default(expr: "uuidV4()")
  userId: UUID! @col(name: "user_id")
  loanNumber: String! @col(name: "loan_number")
  borrowerName: String! @col(name: "borrower_name")
  borrowerEmail: String @col(name: "borrower_email")
  loanAmount: Float @col(name: "loan_amount")
  loanType: String @col(name: "loan_type")
  status: String! @default(value: "active")
  propertyAddress: String @col(name: "property_address")
  loanOfficerId: UUID @col(name: "loan_officer_id")
  notes: String
  createdAt: Timestamp! @default(expr: "request.time")
  updatedAt: Timestamp! @default(expr: "request.time")
  closedAt: Timestamp @col(name: "closed_at")
}

extend type Loan @index(fields: ["userId"], name: "idx_loan_user")
extend type Loan @index(fields: ["loanNumber"], name: "idx_loan_number")
extend type Loan @index(fields: ["status"], name: "idx_loan_status")

type File @table {
  id: UUID! @default(expr: "uuidV4()")
  userId: UUID! @col(name: "user_id")
  loanId: UUID @col(name: "loan_id") # Nullable - null means personal file
  loan: Loan @ref(fields: "loanId") # Relationship to Loan
  documentMasterId: UUID @col(name: "document_master_id") # Nullable - FK to DocumentMaster for naming convention
  documentMaster: DocumentMaster @ref(fields: "documentMasterId") # Relationship to DocumentMaster
  originalFilename: String! @col(name: "original_filename")
  storagePath: String! @col(name: "storage_path")
  fileSize: Int! @col(name: "file_size")
  mimeType: String @col(name: "mime_type")
  fileExtension: String @col(name: "file_extension")
  uploadedAt: Timestamp! @default(expr: "request.time")
  updatedAt: Timestamp! @default(expr: "request.time")
  isDeleted: Boolean! @default(value: false)
  deletedAt: Timestamp @col(name: "deleted_at")
  deletedBy: UUID @col(name: "deleted_by")
  tags: String @col(name: "tags")
  description: String
  downloadUrl: String @col(name: "download_url")
}

extend type File @index(fields: ["userId"], name: "idx_file_user")
extend type File @index(fields: ["loanId"], name: "idx_file_loan")
extend type File @index(fields: ["documentMasterId"], name: "idx_file_document_master")
extend type File @index(fields: ["storagePath"], name: "idx_file_path")
extend type File @index(fields: ["isDeleted"], name: "idx_file_deleted")

type FileLoanAssociation @table(name: "file_loan_associations") {
  id: UUID! @default(expr: "uuidV4()")
  fileId: UUID! @col(name: "file_id")
  loanId: UUID! @col(name: "loan_id")
  associatedAt: Timestamp! @default(expr: "request.time")
  associatedBy: UUID @col(name: "associated_by")
}

extend type FileLoanAssociation @index(fields: ["fileId"], name: "idx_fla_file")
extend type FileLoanAssociation @index(fields: ["loanId"], name: "idx_fla_loan")

type AuthSession @table(name: "auth_sessions") {
  id: UUID! @default(expr: "uuidV4()")
  sessionId: String! @col(name: "session_id")
  userId: UUID! @col(name: "user_id")
  user: User! @ref(fields: "userId")
  loanIds: String @col(name: "loan_ids") # JSON array of loan UUIDs borrower can access
  emailHash: String! @col(name: "email_hash")
  magicToken: String @col(name: "magic_token")
  sessionToken: String @col(name: "session_token")
  tokenType: String! @default(value: "magic_link")
  status: String! @default(value: "pending")
  expiresAt: Timestamp! @col(name: "expires_at")
  createdAt: Timestamp! @default(expr: "request.time")
  verifiedAt: Timestamp @col(name: "verified_at")
  lastAccessedAt: Timestamp @col(name: "last_accessed_at")
  revokedAt: Timestamp @col(name: "revoked_at")
  revokedBy: UUID @col(name: "revoked_by")
  revokeReason: String @col(name: "revoke_reason")
  ipAddress: String @col(name: "ip_address")
  userAgent: String @col(name: "user_agent")
  createdBy: UUID @col(name: "created_by")
  # Firebase Email Link Auth fields
  firebaseUid: String @col(name: "firebase_uid")
  borrowerContactId: String @col(name: "borrower_contact_id")
  loanNumber: String @col(name: "loan_number")
  # Password creation tracking
  usedForPasswordCreation: Boolean! @default(value: false) @col(name: "used_for_password_creation")
}

extend type AuthSession @index(fields: ["sessionId"], name: "idx_auth_session_id")
extend type AuthSession @index(fields: ["userId"], name: "idx_auth_user")
extend type AuthSession @index(fields: ["status"], name: "idx_auth_status")
extend type AuthSession @index(fields: ["emailHash"], name: "idx_auth_email_hash")
extend type AuthSession @index(fields: ["firebaseUid"], name: "idx_auth_firebase_uid")

type MagicLink @table(name: "magic_links") {
  id: UUID! @default(expr: "uuidV4()")
  userId: UUID! @col(name: "user_id")
  user: User! @ref(fields: "userId")
  borrowerEmail: String! @col(name: "borrower_email")
  sendToEmail: String! @col(name: "send_to_email")
  magicLinkUrl: String! @col(name: "magic_link_url")
  sessionId: String @col(name: "session_id")
  expiresAt: Timestamp! @col(name: "expires_at")
  createdAt: Timestamp! @default(expr: "request.time")
  createdBy: UUID @col(name: "created_by")
  sentAt: Timestamp @col(name: "sent_at")
  lastSentAt: Timestamp @col(name: "last_sent_at")
  sendCount: Int! @default(value: 0) @col(name: "send_count")
  usedAt: Timestamp @col(name: "used_at")
  isActive: Boolean! @default(value: true) @col(name: "is_active")
  revokedAt: Timestamp @col(name: "revoked_at")
  revokedBy: UUID @col(name: "revoked_by")
  revokeReason: String @col(name: "revoke_reason")
}

extend type MagicLink @index(fields: ["userId"], name: "idx_magic_link_user")
extend type MagicLink @index(fields: ["sessionId"], name: "idx_magic_link_session")
extend type MagicLink @index(fields: ["expiresAt"], name: "idx_magic_link_expires")
extend type MagicLink @index(fields: ["isActive"], name: "idx_magic_link_active")

type VerificationCode @table(name: "verification_codes") {
  id: UUID! @default(expr: "uuidV4()")
  sessionId: String! @col(name: "session_id")
  codeHash: String! @col(name: "code_hash")
  expiresAt: Timestamp! @col(name: "expires_at")
  createdAt: Timestamp! @default(expr: "request.time")
  usedAt: Timestamp @col(name: "used_at")
  attemptCount: Int! @default(value: 0)
  maxAttempts: Int! @default(value: 3)
  isUsed: Boolean! @default(value: false)
}

extend type VerificationCode @index(fields: ["sessionId"], name: "idx_vcode_session")

type AuthAuditLog @table(name: "auth_audit_log") {
  id: UUID! @default(expr: "uuidV4()")
  sessionId: String @col(name: "session_id")
  userId: UUID @col(name: "user_id")
  eventType: String! @col(name: "event_type")
  success: Boolean!
  errorMessage: String @col(name: "error_message")
  errorCode: String @col(name: "error_code")
  ipAddress: String @col(name: "ip_address")
  userAgent: String @col(name: "user_agent")
  requestPayload: String @col(name: "request_payload")
  createdAt: Timestamp! @default(expr: "request.time")
}

extend type AuthAuditLog @index(fields: ["userId"], name: "idx_audit_user")
extend type AuthAuditLog @index(fields: ["eventType"], name: "idx_audit_event")

type RateLimitTracking @table(name: "rate_limit_tracking") {
  id: UUID! @default(expr: "uuidV4()")
  identifier: String!
  actionType: String! @col(name: "action_type")
  attemptCount: Int! @default(value: 1)
  windowStartAt: Timestamp! @default(expr: "request.time")
  blockedUntil: Timestamp @col(name: "blocked_until")
}

extend type RateLimitTracking @index(fields: ["identifier", "actionType"], name: "idx_rate_limit")

# ============================================================================
# DOCUMENT MANAGEMENT TABLES (Migrated from portal-api)
# These tables define the folder structure for loan documents
# ============================================================================

# DocumentPath - Defines folder paths/categories for organizing documents
# Represents a hierarchical folder structure (e.g., "1 - Borrower Docs/1.1 - Company")
type DocumentPath @table(name: "document_paths") {
  id: UUID! @default(expr: "uuidV4()")
  name: String! # Full path name (e.g., "1 - Borrower Docs/1.1 - Company")
  sourceLookupId: UUID @col(name: "source_lookup_id") # Reference to source type
  isActive: Boolean! @default(value: true) @col(name: "is_active")
  description: String
  sortOrder: Int! @default(value: 0) @col(name: "sort_order")
  createdOn: Timestamp! @default(expr: "request.time") @col(name: "created_on")
  createdBy: String @col(name: "created_by")
  updatedOn: Timestamp! @default(expr: "request.time") @col(name: "updated_on")
  updatedBy: String @col(name: "updated_by")
}

extend type DocumentPath @index(fields: ["name"], name: "idx_document_path_name")
extend type DocumentPath @index(fields: ["isActive"], name: "idx_document_path_active")
extend type DocumentPath @index(fields: ["sortOrder"], name: "idx_document_path_sort")

# DocumentMaster - Defines document types that can be placed in document paths
# Maps specific document types (e.g., "Loan Agreement") to their folder locations
type DocumentMaster @table(name: "document_masters") {
  id: UUID! @default(expr: "uuidV4()")
  name: String! # Document type name (e.g., "Loan Agreement", "Borrower Narrative")
  documentPathId: UUID @col(name: "document_path_id") # FK to DocumentPath
  documentPath: DocumentPath @ref(fields: "documentPathId") # Relationship to DocumentPath
  isActive: Boolean! @default(value: true) @col(name: "is_active")
  description: String
  sortOrder: Int! @default(value: 0) @col(name: "sort_order")
  # Document behavior flags
  isSystemGenerated: Boolean! @default(value: false) @col(name: "is_system_generated")
  reviewRequired: Boolean! @default(value: false) @col(name: "review_required")
  isVersioningEnabled: Boolean! @default(value: false) @col(name: "is_versioning_enabled")
  # Naming and display
  namingConvention: String @col(name: "naming_convention")
  display: String # Display name override
  # Audit fields
  createdOn: Timestamp! @default(expr: "request.time") @col(name: "created_on")
  createdBy: String @col(name: "created_by")
  updatedOn: Timestamp! @default(expr: "request.time") @col(name: "updated_on")
  updatedBy: String @col(name: "updated_by")
}

extend type DocumentMaster @index(fields: ["name"], name: "idx_document_master_name")
extend type DocumentMaster @index(fields: ["documentPathId"], name: "idx_document_master_path")
extend type DocumentMaster @index(fields: ["isActive"], name: "idx_document_master_active")
extend type DocumentMaster @index(fields: ["sortOrder"], name: "idx_document_master_sort")
