# ============================================================================
# USER QUERIES
# ============================================================================

query GetUser($id: UUID!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by authenticated users to fetch user profile data. Frontend validates user ownership before calling."
) {
  user(id: $id) {
    id
    email
    firstName
    lastName
    role
    isActive
    phoneNumber
    hasPassword
    googleAuthUid
    isTemporary
    createdAt
    lastLoginAt
  }
}

query GetUserByEmail($email: String!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by Cloud Functions during authentication to look up users by email. Frontend access is controlled through authenticated Cloud Functions."
) {
  users(where: { email: { eq: $email } }) {
    id
    email
    firstName
    lastName
    role
    isActive
    hasPassword
    googleAuthUid
    isTemporary
  }
}

query ListAllUsers @auth(
  level: PUBLIC
  insecureReason: "This query is used by super-admin users only. Frontend enforces role-based access control via RequireSuperAdmin component."
) {
  users(orderBy: { createdAt: DESC }) {
    id
    email
    firstName
    lastName
    role
    isActive
    createdAt
  }
}

# ============================================================================
# LOAN QUERIES
# ============================================================================

query GetUserLoans($userId: UUID!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by authenticated users to fetch their own loans. Frontend validates user ownership before calling."
) {
  loans(where: { userId: { eq: $userId } }, orderBy: { createdAt: DESC }) {
    id
    loanNumber
    borrowerName
    borrowerEmail
    loanAmount
    loanType
    status
    propertyAddress
    createdAt
    closedAt
  }
}

query GetLoan($id: UUID!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by authenticated users to fetch loan details. Frontend validates user ownership before calling."
) {
  loan(id: $id) {
    id
    userId
    loanNumber
    borrowerName
    borrowerEmail
    loanAmount
    loanType
    status
    propertyAddress
    loanOfficerId
    notes
    createdAt
    updatedAt
    closedAt
  }
}

query GetLoanByNumber($loanNumber: String!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by authenticated users to look up loans by number. Frontend enforces authentication."
) {
  loans(where: { loanNumber: { eq: $loanNumber } }) {
    id
    userId
    loanNumber
    borrowerName
    loanAmount
    status
  }
}

# ============================================================================
# FILE QUERIES
# ============================================================================

query GetUserFiles($userId: UUID!, $includeDeleted: Boolean) @auth(
  level: PUBLIC
  insecureReason: "This query is used by authenticated users to fetch their files. Frontend validates user ownership before calling."
) {
  files(
    where: {
      userId: { eq: $userId }
      isDeleted: { eq: $includeDeleted }
    }
    orderBy: { uploadedAt: DESC }
  ) {
    id
    userId
    loanId
    documentMasterId
    documentMaster {
      id
      name
      namingConvention
      isVersioningEnabled
    }
    originalFilename
    storagePath
    fileSize
    mimeType
    fileExtension
    uploadedAt
    tags
    description
    downloadUrl
    isDeleted
  }
}

query GetFilesByLoan($loanId: UUID!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by authenticated users to fetch files associated with a loan. Frontend validates user ownership before calling."
) {
  fileLoanAssociations(where: { loanId: { eq: $loanId } }) {
    id
    fileId
    loanId
    associatedAt
  }
}

query GetFile($id: UUID!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by authenticated users to fetch file details. Frontend validates user ownership before calling."
) {
  file(id: $id) {
    id
    userId
    loanId
    documentMasterId
    documentMaster {
      id
      name
      namingConvention
      isVersioningEnabled
    }
    originalFilename
    storagePath
    fileSize
    mimeType
    fileExtension
    uploadedAt
    updatedAt
    tags
    description
    downloadUrl
    isDeleted
    deletedAt
    deletedBy
  }
}

query GetFilesWithAssociations($userId: UUID!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by authenticated users to fetch files with loan associations. Frontend validates user ownership before calling."
) {
  files(
    where: {
      userId: { eq: $userId }
      isDeleted: { eq: false }
    }
  ) {
    id
    originalFilename
    fileSize
    uploadedAt
  }
}

# ============================================================================
# FILE-LOAN ASSOCIATION QUERIES
# ============================================================================

query GetFileAssociations($fileId: UUID!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by authenticated users to fetch file-loan associations. Frontend validates user ownership before calling."
) {
  fileLoanAssociations(where: { fileId: { eq: $fileId } }) {
    id
    loanId
    associatedAt
  }
}

query GetLoanAssociations($loanId: UUID!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by authenticated users to fetch loan-file associations. Frontend validates user ownership before calling."
) {
  fileLoanAssociations(where: { loanId: { eq: $loanId } }) {
    id
    fileId
    associatedAt
  }
}

# ============================================================================
# AUTHENTICATION QUERIES
# ============================================================================

query GetAuthSession($sessionId: String!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by Cloud Functions to validate auth sessions. Frontend access is controlled through authenticated Cloud Functions."
) {
  authSessions(where: { sessionId: { eq: $sessionId } }) {
    id
    sessionId
    userId
    loanIds
    emailHash
    tokenType
    status
    expiresAt
    createdAt
    verifiedAt
    lastAccessedAt
    ipAddress
    userAgent
  }
}

query GetUserAuthSessions($userId: UUID!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by authenticated users to view their active sessions. Frontend validates user ownership before calling."
) {
  authSessions(
    where: {
      userId: { eq: $userId }
      status: { eq: "verified" }
    }
    orderBy: { createdAt: DESC }
  ) {
    sessionId
    expiresAt
    lastAccessedAt
    createdAt
    ipAddress
  }
}

query GetVerificationCode($sessionId: String!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by Cloud Functions to verify codes. Frontend access is controlled through authenticated Cloud Functions."
) {
  verificationCodes(
    where: { sessionId: { eq: $sessionId } }
    orderBy: { createdAt: DESC }
    limit: 1
  ) {
    id
    sessionId
    codeHash
    expiresAt
    attemptCount
    maxAttempts
    isUsed
    usedAt
  }
}

query GetAuthAuditLogs($userId: UUID, $limit: Int) @auth(
  level: PUBLIC
  insecureReason: "This query is used by admin users to view auth audit logs. Frontend enforces role-based access control."
) {
  authAuditLogs(
    where: { userId: { eq: $userId } }
    orderBy: { createdAt: DESC }
    limit: $limit
  ) {
    id
    sessionId
    eventType
    success
    errorMessage
    ipAddress
    createdAt
  }
}

# Firebase Email Link Auth queries
query GetAuthSessionByFirebaseUid($firebaseUid: String!, $email: String!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by Cloud Functions to look up auth sessions by Firebase UID. Frontend access is controlled through authenticated Cloud Functions."
) {
  authSessions(
    where: { firebaseUid: { eq: $firebaseUid } }
    orderBy: { createdAt: DESC }
    limit: 1
  ) {
    id
    sessionId
    userId
    loanIds
    emailHash
    status
    expiresAt
    verifiedAt
    createdAt
    borrowerContactId
    loanNumber
    firebaseUid
    user {
      id
      email
      role
      firstName
      lastName
      hasPassword
      googleAuthUid
      isTemporary
    }
  }
}

query GetAuthSessionByEmailHash($emailHash: String!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by Cloud Functions to look up auth sessions by email hash. Frontend access is controlled through authenticated Cloud Functions."
) {
  authSessions(
    where: {
      emailHash: { eq: $emailHash }
      status: { eq: "active" }
    }
    orderBy: { createdAt: DESC }
    limit: 1
  ) {
    id
    sessionId
    userId
    loanIds
    emailHash
    status
    expiresAt
    verifiedAt
    borrowerContactId
    loanNumber
    firebaseUid
  }
}

query GetActiveAuthSessionForUser($userId: UUID!) @auth(
  level: PUBLIC
  insecureReason: "This query is used to check for active auth sessions. Frontend validates user ownership before calling."
) {
  authSessions(
    where: {
      userId: { eq: $userId }
      status: { eq: "active" }
    }
    orderBy: { lastAccessedAt: DESC }
    limit: 1
  ) {
    id
    sessionId
    userId
    loanIds
    status
    expiresAt
    lastAccessedAt
    borrowerContactId
    loanNumber
  }
}

# ============================================================================
# DASHBOARD / COMPOSITE QUERIES
# ============================================================================

query GetDashboard($userId: UUID!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by authenticated users to fetch dashboard data. Frontend validates user ownership before calling."
) {
  user(id: $userId) {
    id
    email
    firstName
    lastName
    role
  }
  loans(where: { userId: { eq: $userId } }) {
    id
    loanNumber
    borrowerName
    loanAmount
    status
    createdAt
  }
  files(
    where: {
      userId: { eq: $userId }
      isDeleted: { eq: false }
    }
    orderBy: { uploadedAt: DESC }
    limit: 10
  ) {
    id
    originalFilename
    fileSize
    uploadedAt
  }
}

query GetLoanDetails($loanId: UUID!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by authenticated users to fetch loan details with file associations. Frontend validates user ownership before calling."
) {
  loan(id: $loanId) {
    id
    loanNumber
    borrowerName
    borrowerEmail
    loanAmount
    loanType
    status
    propertyAddress
    notes
    createdAt
  }
  fileLoanAssociations(where: { loanId: { eq: $loanId } }) {
    id
    fileId
    associatedAt
  }
}

# ============================================================================
# MAGIC LINK QUERIES
# ============================================================================

query GetUserMagicLinks($userId: UUID!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by admin users to view magic links for a specific user. Frontend enforces role-based access control."
) {
  magicLinks(
    where: { userId: { eq: $userId } }
    orderBy: { createdAt: DESC }
  ) {
    id
    userId
    borrowerEmail
    sendToEmail
    magicLinkUrl
    sessionId
    expiresAt
    createdAt
    createdBy
    sentAt
    lastSentAt
    sendCount
    usedAt
    isActive
    revokedAt
    revokedBy
    revokeReason
  }
}

query GetActiveMagicLinks($userId: UUID!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by admin users to view active magic links. Frontend enforces role-based access control."
) {
  magicLinks(
    where: {
      userId: { eq: $userId }
      isActive: { eq: true }
    }
    orderBy: { createdAt: DESC }
  ) {
    id
    userId
    borrowerEmail
    sendToEmail
    magicLinkUrl
    expiresAt
    createdAt
    sentAt
    lastSentAt
    sendCount
    usedAt
  }
}

query GetMagicLink($id: UUID!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by admin users to view magic link details. Frontend enforces role-based access control."
) {
  magicLink(id: $id) {
    id
    userId
    borrowerEmail
    sendToEmail
    magicLinkUrl
    sessionId
    expiresAt
    createdAt
    createdBy
    sentAt
    lastSentAt
    sendCount
    usedAt
    isActive
    revokedAt
    revokedBy
    revokeReason
    user {
      id
      email
      firstName
      lastName
      role
    }
  }
}

query GetMagicLinkBySessionId($sessionId: String!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by Cloud Functions to check magic link status when users sign in. Frontend access is controlled through authenticated Cloud Function."
) {
  magicLinks(
    where: { sessionId: { eq: $sessionId } }
    orderBy: { createdAt: DESC }
    limit: 1
  ) {
    id
    userId
    borrowerEmail
    sendToEmail
    expiresAt
    usedAt
    isActive
  }
}

# Magic Link Analytics
query GetMagicLinkStats @auth(
  level: PUBLIC
  insecureReason: "This query is used by admin users for analytics. Frontend enforces role-based access control."
) {
  magicLinks {
    id
    userId
    expiresAt
    createdAt
    usedAt
    isActive
  }
}

# ============================================================================
# DOCUMENT PATH QUERIES
# ============================================================================

query ListDocumentPaths @auth(
  level: PUBLIC
  insecureReason: "This query is used by admin users to manage document paths. Frontend enforces role-based access control via RequireAdmin component."
) {
  documentPaths(orderBy: { sortOrder: ASC }) {
    id
    name
    sourceLookupId
    isActive
    description
    sortOrder
    createdOn
    createdBy
    updatedOn
    updatedBy
  }
}

query ListActiveDocumentPaths @auth(
  level: PUBLIC
  insecureReason: "This query is used to fetch active document paths for file organization. Frontend enforces authentication."
) {
  documentPaths(
    where: { isActive: { eq: true } }
    orderBy: { sortOrder: ASC }
  ) {
    id
    name
    sourceLookupId
    description
    sortOrder
  }
}

query GetDocumentPath($id: UUID!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by admin users to view document path details. Frontend enforces role-based access control."
) {
  documentPath(id: $id) {
    id
    name
    sourceLookupId
    isActive
    description
    sortOrder
    createdOn
    createdBy
    updatedOn
    updatedBy
  }
}

query GetDocumentPathByName($name: String!) @auth(
  level: PUBLIC
  insecureReason: "This query is used to lookup document paths by name. Frontend enforces authentication."
) {
  documentPaths(where: { name: { eq: $name } }) {
    id
    name
    sourceLookupId
    isActive
    description
    sortOrder
  }
}

# ============================================================================
# DOCUMENT MASTER QUERIES
# ============================================================================

query ListDocumentMasters @auth(
  level: PUBLIC
  insecureReason: "This query is used by admin users to manage document types. Frontend enforces role-based access control via RequireAdmin component."
) {
  documentMasters(orderBy: { sortOrder: ASC }) {
    id
    name
    documentPathId
    documentPath {
      id
      name
    }
    isActive
    description
    sortOrder
    isSystemGenerated
    reviewRequired
    isVersioningEnabled
    namingConvention
    display
    createdOn
    createdBy
    updatedOn
    updatedBy
  }
}

query ListActiveDocumentMasters @auth(
  level: PUBLIC
  insecureReason: "This query is used to fetch active document types for file organization. Frontend enforces authentication."
) {
  documentMasters(
    where: { isActive: { eq: true } }
    orderBy: { sortOrder: ASC }
  ) {
    id
    name
    documentPathId
    documentPath {
      id
      name
    }
    description
    sortOrder
    namingConvention
    display
  }
}

query GetDocumentMaster($id: UUID!) @auth(
  level: PUBLIC
  insecureReason: "This query is used by admin users to view document type details. Frontend enforces role-based access control."
) {
  documentMaster(id: $id) {
    id
    name
    documentPathId
    documentPath {
      id
      name
    }
    isActive
    description
    sortOrder
    isSystemGenerated
    reviewRequired
    isVersioningEnabled
    namingConvention
    display
    createdOn
    createdBy
    updatedOn
    updatedBy
  }
}

query ListDocumentMastersByPath($documentPathId: UUID!) @auth(
  level: PUBLIC
  insecureReason: "This query is used to fetch document types for a specific path. Frontend enforces authentication."
) {
  documentMasters(
    where: { documentPathId: { eq: $documentPathId } }
    orderBy: { sortOrder: ASC }
  ) {
    id
    name
    documentPathId
    isActive
    description
    sortOrder
    namingConvention
    display
  }
}

query GetDocumentMasterByName($name: String!) @auth(
  level: PUBLIC
  insecureReason: "This query is used to lookup document types by name. Frontend enforces authentication."
) {
  documentMasters(where: { name: { eq: $name } }) {
    id
    name
    documentPathId
    documentPath {
      id
      name
    }
    isActive
    description
    sortOrder
  }
}
